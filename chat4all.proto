syntax = "proto3";

package chat4all;

// 1. Definição dos Serviços (Interface da API)

service ChatService {
  // 6.1 Autenticação
  rpc GetToken (TokenRequest) returns (TokenResponse);

  // 6.2 Conversas
  rpc CreateConversation (ConversationCreateRequest) returns (Conversation);
  
  // 6.2 Listar Mensagens (Server Streaming)
  rpc ListMessages (ListMessagesRequest) returns (stream Message);

  // 6.3 Enviar Mensagem (Ingestão)
  rpc SendMessage (SendMessageRequest) returns (SendMessageResponse);

  // 6.4 Receber Notificação de Status (Callback/Webhook)
  rpc ReceiveNotification(NotificationRequest) returns (NotificationResponse);

  // NOVO: RPC para Mapear Usuários (Se você for adicionar este serviço na API)
  rpc MapUser (MapUserRequest) returns (MapUserResponse);
}

// --- SERVIÇO DE ARQUIVOS (Object Storage Gateway) ---

service FileService {
  // 1. Inicia o upload e retorna URLs pré-assinadas para as partes
  rpc GetUploadUrl(GetUploadUrlRequest) returns (GetUploadUrlResponse);

  // 2. Finaliza o upload multipart no Object Storage
  rpc CompleteUpload(CompleteUploadRequest) returns (CompleteUploadResponse);

  // 3. Retorna uma URL temporária para download
  rpc GetDownloadUrl(GetDownloadUrlRequest) returns (GetDownloadUrlResponse);
}

// 2. Mensagens e Estruturas de Dados

// --- Estruturas de Autenticação ---
message TokenRequest {
  string client_id = 1;
  string client_secret = 2;
}

message TokenResponse {
  string access_token = 1;
  int32 expires_in = 2;
}

// --- Estruturas de Conversas ---
message ConversationCreateRequest {
  enum ConversationType {
    PRIVATE = 0;
    GROUP = 1;
  }
  ConversationType type = 1;
  repeated string members = 2;
  map<string, string> metadata = 3;
}

message Conversation {
  string id = 1;
  ConversationCreateRequest.ConversationType type = 2;
  repeated string members = 3;
  map<string, string> metadata = 4;
}

// --- Estruturas de Mensagens ---
message ListMessagesRequest {
  string conversation_id = 1;
  int64 since_timestamp = 2;
}

message MessagePayload {
  string type = 1; // "text" ou "file"
  string text = 2;
  // O oneof não é estritamente necessário se você usar o `type` acima.
}

message SendMessageRequest {
  string message_id = 1;
  string conversation_id = 2;
  string from_user = 3;
  repeated string to = 4;
  repeated string channels = 5; 
  MessagePayload payload = 6;
  map<string, string> metadata = 7;
  repeated FileMetadata file_attachments = 8;
  int64 seq_num = 9;
}

message SendMessageResponse {
  string status = 1;
  string message_id = 2;
}

// --- Status de Mensagem (Rastreio) ---
enum MessageStatus {
  MESSAGE_STATUS_UNSPECIFIED = 0;
  SENT = 1;       // Aceito pelo servidor (Persistido no Mongo)
  DELIVERED = 2;  // Entregue ao Router/Middleware
  SENT_TO_EXTERNAL = 3; // Enviada à API externa (WhatsApp, Instagram, etc.)
  RECEIVED = 4;   // Recebida pelo dispositivo alvo
  READ = 5;       // Lida pelo usuário alvo
  FAILED = 6;
}

// --- Estruturas de Callback de Status ---
message NotificationRequest {
  string message_id = 1;
  MessageStatus status = 2;
  string channel = 3;
  string remote_id = 4;
}

message NotificationResponse {
  bool success = 1;
  string message = 2;
}

// --- Estruturas de Mapeamento de Usuário ---
message MapUserRequest {
  string internal_id = 1;
  string whatsapp_id = 2;
  string instagram_id = 3;
  // Poderia ser mais genérico: repeated UserChannelMapping mappings = 4;
}

message MapUserResponse {
  bool success = 1;
}


// ===================================================
// 3. Estruturas de Arquivos (FileService)
// ===================================================

// --- Metadados e Status Final ---
message FileMetadata {
  string file_id = 1;
  string filename = 2;
  string mime_type = 3;
  int64 size_bytes = 4;
  string checksum_sha256 = 5;
  string uploader_id = 6;
  string conversation_id = 7;
  string storage_bucket = 8;
  string storage_key = 9;
}

message Message {
  SendMessageRequest message_data = 1;
  int64 timestamp = 2;
  MessageStatus status = 3;
}

// --- Upload Multipart ---
message CompletedPart {
  string part_etag = 1;
  int32 part_number = 2;
}

message CompleteUploadRequest {
  string file_id = 1;
  string upload_session_id = 2;
  repeated CompletedPart completed_parts = 3;
  string checksum_sha256 = 4;
  string conversation_id = 5;
  int64 file_size = 6;
}

message CompleteUploadResponse {
  string file_id = 1;
  bool success = 2;
  string message = 3;
  FileMetadata file_metadata = 4;
}

message GetUploadUrlRequest {
  string filename = 1;
  string conversation_id = 2;
  int64 file_size = 3;
  int32 num_parts = 4;
}

message UploadPartInfo {
  int32 part_number = 1;
  string presigned_url = 2;
}

message GetUploadUrlResponse {
  string file_id = 1;
  string upload_session_id = 2;
  repeated UploadPartInfo parts = 3;
}

// --- Download ---
message GetDownloadUrlRequest {
  string file_id = 1;
}

message GetDownloadUrlResponse {
  string presigned_url = 1;
  string filename = 2;
  string mime_type = 3;
}