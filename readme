# Chat4All v2: Plataforma de Comunicação Ubíqua (API gRPC/Kafka/MongoDB)

O Chat4All v2 é uma plataforma de comunicação escalável e assíncrona, projetada para rotear mensagens entre usuários em múltiplos canais. Esta documentação cobre a primeira fase de implementação, focada na arquitetura de persistência e roteamento via gRPC e Kafka.

## Arquitetura e Fluxo de Dados

A comunicação externa é feita via **gRPC**. Internamente, o sistema utiliza o **Apache Kafka** para desacoplar a ingestão da mensagem (Producer) da persistência e do roteamento (Consumers/Workers).

**Fluxo de uma Mensagem:**
1. **Cliente:** Envia mensagem via RPC `SendMessage`.
2. **`server.py` (gRPC Gateway/Producer):** Autentica, valida e publica a mensagem no tópico `messages` do Kafka (Status: **PENDING**).
3. **`worker.py` (Persister Consumer):** Consome a mensagem, salva no MongoDB (Status: **SENT**).
4. **`router_worker.py` (Router Consumer):** Consome a mesma mensagem, simula a entrega e atualiza o status no MongoDB para **DELIVERED**.
5. **Cliente:** Usa RPC `ListMessages` para ler o histórico completo e o estado final (`DELIVERED`).

## Endpoints e Contratos

A API é definida usando **Protocol Buffers** (gRPC).

### 1. Autenticação (GetToken)

| RPC | Método | Entrada | Saída | Descrição |
| :--- | :--- | :--- | :--- | :--- |
| `GetToken` | Unário | `TokenRequest` | `TokenResponse` | Gera um token JWT simples para acesso aos serviços. |

**Exemplo de Uso (Cliente):**

```python
# client.py: Obter Token
stub.GetToken(chat4all_pb2.TokenRequest(client_id="admin_client", client_secret="super_secret_key"))

# client.py: Listar Mensagens
stub.ListMessages(
    chat4all_pb2.ListMessagesRequest(
        conversation_id=CONVERSATION_ID,
        since_timestamp=0 
    ),
    metadata=get_auth_metadata(ACCESS_TOKEN) # Requer autenticação!
)

1. Configuração Inicial e Stubs
Instale as dependências e gere os arquivos Python a partir do contrato Protobuf.

Bash

# 1. Instalar dependências (dentro do .venv)
pip install -r requirements.txt 

# 2. Gerar arquivos gRPC Stubs
python -m grpc_tools.protoc -I. --python_out=. --grpc_python_out=. chat4all.proto
2. Inicialização da Infraestrutura (Docker Compose)
O arquivo docker-compose.yml gerencia o ciclo de vida do MongoDB, Kafka e ZooKeeper.

Ação: Execute o comando para iniciar a infraestrutura em background.

Bash

# Inicia todos os serviços (Kafka, MongoDB, etc.)
docker-compose up -d --build

3. Execução dos Serviços Python
Os componentes Python (Server e Workers) devem ser rodados fora do Docker (para facilitar o desenvolvimento e debug), conectando-se aos contêineres Docker via localhost.

Abra três terminais separados e execute cada script
python server.py
python worker.py
python router_worker.py

4. Testando a Plataforma
Use o client.py para enviar mensagens e listar o histórico.

